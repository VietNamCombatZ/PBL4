services:
  controller:
    build: .
    image: aco-sagsin-sim:latest
    container_name: aco-controller
    command: ["uvicorn", "src.services.controller:app", "--host", "0.0.0.0", "--port", "8080"]
    depends_on:
      - mongo
    ports:
      - "8080:8080"
    environment:
      - PYTHONUNBUFFERED=1
      - EPOCH_SEC=${EPOCH_SEC:-10}
      - OFFLINE=${OFFLINE:-false}
      # MongoDB (optional)
      - ENABLE_DB=${ENABLE_DB:-true}
      - MONGO_URI=${MONGO_URI:-mongodb://mongo:27017}
      - MONGO_DB=${MONGO_DB:-aco}
      - MONGO_CACHE_COLLECTION=${MONGO_CACHE_COLLECTION:-cache}
      - MONGO_NODES_COLLECTION=${MONGO_NODES_COLLECTION:-nodes}
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./data:/app/data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/nodes"]
      interval: 20s
      timeout: 5s
      retries: 10

  node:
    image: aco-sagsin-sim:latest
    depends_on:
      - controller
    environment:
      - PYTHONUNBUFFERED=1
      # Strictly derive NODE_INDEX from container name; exit if not derivable
      - FORCE_DERIVED_INDEX=true
      - NODE_INDEX
    command: ["python", "-m", "src.services.node_agent"]
    volumes:
      - ./data/generated:/app/data/generated
      - ./data/node_assignments:/var/lib/aco/node_assignments
      # optional: mount docker socket read-only to allow strict index derivation via container metadata
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      replicas: ${NODES:-50}
    healthcheck:
      # Healthy only if NODE_INDEX is present (set by entrypoint). If derivation fails (strict), container exits.
      test: ["CMD", "python", "-c", "import os,sys; i=os.environ.get('NODE_INDEX'); sys.exit(0 if i and i.isdigit() else 1)"]
      interval: 20s
      timeout: 5s
      retries: 3

  ui:
    image: aco-sagsin-sim:latest
    depends_on:
      - controller
    environment:
      - PYTHONUNBUFFERED=1
    command: ["streamlit", "run", "src/ui/app.py", "--server.port", "8501", "--server.address", "0.0.0.0"]
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data

  mongo:
    image: mongo:6
    container_name: aco-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

networks:
  default:
    name: aco-sagsin
    driver: bridge

volumes:
  mongo_data:
    driver: local
